---
title: "Democratic Share vs. RCV Yes Share by Locale"
author: "Jesse Brandt"
format: html
execute:
  echo: false
  warning: false
---

```{r}
library(dplyr)
library(ggplot2)
library(scales)
library(plotly)

load("../data/rcv_data.RData")
```

The values below use `yes_share = YES / (YES + NO)` (contested votes only) and
`dem_share = Democratic votes / total presidential votes cast`. Both are computed
consistently across all 8 locales in the new pipeline.

```{r}
#| fig-width: 9
#| fig-height: 6

locale_colors <- c(
  Alaska        = "#E41A1C",
  Maine         = "#FF7F00",
  Massachusetts = "#984EA3",
  Albany        = "#4DAF4A",
  Bloomington   = "#377EB8",
  Boulder       = "#A65628",
  Eureka        = "#F781BF",
  Minnetonka    = "#999999"
)

states_and_cities %>%
  filter(!is.na(yes_share), !is.na(dem_share)) %>%
  ggplot(aes(x = dem_share, y = yes_share, color = locale)) +
  geom_point(size = 1.2, alpha = 0.6) +
  geom_smooth(aes(group = locale), method = "lm", se = FALSE,
              linewidth = 0.7) +
  scale_color_manual(values = locale_colors) +
  scale_x_continuous(labels = percent_format(accuracy = 1), limits = c(0, 1)) +
  scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0, 1)) +
  labs(
    x     = "Democratic Presidential Vote Share",
    y     = "RCV Ballot Measure Yes Vote Share",
    color = "Locale"
  ) +
  theme_bw(base_size = 12) +
  theme(legend.position = "right")
```

```{r}
#| fig-width: 9
#| fig-height: 6

lpw_colors <- c("TRUE" = "#D73027", "FALSE" = "#4575B4")

states_and_cities %>%
  filter(!is.na(yes_share), !is.na(dem_share)) %>%
  mutate(recent_lpw = as.character(recent_lpw)) %>%
  ggplot(aes(x = dem_share, y = yes_share,
             color = recent_lpw, shape = locale)) +
  geom_point(size = 1.8, alpha = 0.65) +
  geom_smooth(aes(group = recent_lpw), method = "lm", se = FALSE,
              linewidth = 0.9) +
  scale_color_manual(values = lpw_colors,
                     labels = c("TRUE" = "Yes", "FALSE" = "No")) +
  scale_shape_manual(values = c(Alaska = 16, Maine = 17, Massachusetts = 15,
                                Albany = 1, Bloomington = 2, Boulder = 0,
                                Eureka = 5, Minnetonka = 6)) +
  scale_x_continuous(labels = percent_format(accuracy = 1), limits = c(0, 1)) +
  scale_y_continuous(labels = percent_format(accuracy = 1), limits = c(0, 1)) +
  labs(
    x     = "Democratic Presidential Vote Share",
    y     = "RCV Ballot Measure Yes Vote Share",
    color = "Recent low-plurality winner",
    shape = "Locale"
  ) +
  theme_bw(base_size = 12) +
  theme(legend.position = "right")
```

## Interactive (click legend to toggle locales)

```{r}
#| fig-width: 9
#| fig-height: 6

plot_data <- states_and_cities %>%
  filter(!is.na(yes_share), !is.na(dem_share))

# Build one trace per locale so legend clicks toggle individual locales
p <- plot_ly(type = "scatter", mode = "markers")

for (loc in names(locale_colors)) {
  d <- filter(plot_data, locale == loc)
  if (nrow(d) == 0) next

  # OLS fit for trend line
  fit <- lm(yes_share ~ dem_share, data = d)
  xs  <- seq(min(d$dem_share, na.rm = TRUE),
             max(d$dem_share, na.rm = TRUE), length.out = 80)
  ys  <- predict(fit, newdata = data.frame(dem_share = xs))

  p <- p %>%
    add_trace(
      x = d$dem_share, y = d$yes_share,
      name        = loc,
      legendgroup = loc,
      marker      = list(color = locale_colors[[loc]], size = 5, opacity = 0.6),
      text        = paste0(loc, "<br>", d$precinct_id),
      hovertemplate = "%{text}<br>Dem: %{x:.1%}<br>Yes: %{y:.1%}<extra></extra>",
      showlegend  = TRUE
    ) %>%
    add_trace(
      x = xs, y = ys,
      mode        = "lines",
      name        = loc,
      legendgroup = loc,
      line        = list(color = locale_colors[[loc]], width = 1.8),
      hoverinfo   = "skip",
      showlegend  = FALSE
    )
}

p %>% layout(
  xaxis = list(title = "Democratic Presidential Vote Share",
               tickformat = ".0%", range = c(0, 1)),
  yaxis = list(title = "RCV Ballot Measure Yes Vote Share",
               tickformat = ".0%", range = c(0, 1)),
  legend    = list(title = list(text = "Locale")),
  hovermode = "closest"
)
```
